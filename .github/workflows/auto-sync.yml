# .github/workflows/auto-sync.yml
name: "üîÅ auto-sync"

on:
  workflow_call:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-changed-files:
    runs-on: ubuntu-latest
    outputs:
      updated_commits: ${{ steps.sync-commits.outputs.updated_commits }}
      sync_mode: ${{ steps.sync-commits.outputs.sync_mode }}
      sync_pr_url: ${{ steps.sync-commits.outputs.sync_pr_url }}

    steps:
      - name: Checkout PR head branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Sync head branch with base branch (commits)
        id: sync-commits
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          #!/usr/bin/env bash

          GITHUB_API_URL="https://api.github.com"

          git fetch origin "$BASE_BRANCH" "$HEAD_BRANCH"
          git checkout "$HEAD_BRANCH"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          UPDATED_COMMITS="false"
          SYNC_MODE="none"
          SYNC_PR_URL=""
          SYNC_PR_NUMBER=""
          SYNC_BRANCH=""

          COMMITS_FROM_BASE="$(git rev-list --count "HEAD..origin/$BASE_BRANCH" 2>/dev/null || echo 0)"

          if [ "$COMMITS_FROM_BASE" -eq 0 ]; then
            echo "‚ÑπÔ∏è Nenhum commit pendente em $BASE_BRANCH para sincronizar com $HEAD_BRANCH."
            SYNC_COMMITS_MESSAGE="‚ÑπÔ∏è Nenhum commit pendente no ramo base \`$BASE_BRANCH\` para sincronizar com \`$HEAD_BRANCH\`."
          else
            echo "üîÑ Encontrados $COMMITS_FROM_BASE commit(s) em $BASE_BRANCH ainda n√£o presentes em $HEAD_BRANCH."

            if [ "$HEAD_BRANCH" = "main" ] || [ "$HEAD_BRANCH" = "staging" ] || [ "$HEAD_BRANCH" = "development" ]; then
              TS="$(date -u +%Y%m%d-%H%M%S)"
              SYNC_BRANCH="auto-sync/${HEAD_BRANCH}-from-${BASE_BRANCH}-${TS}"

              echo "üîß Branch protegido detectado ($HEAD_BRANCH). Criando branch de sincroniza√ß√£o: $SYNC_BRANCH"

              git checkout -b "$SYNC_BRANCH" "$HEAD_BRANCH"
              git merge --no-ff "origin/$BASE_BRANCH" -m "chore: sync $HEAD_BRANCH with $BASE_BRANCH"

              git push origin "$SYNC_BRANCH"

              PR_TITLE="chore: sync $HEAD_BRANCH with $BASE_BRANCH"
              PR_BODY="PR autom√°tica criada pelo workflow auto-sync para trazer \`$HEAD_BRANCH\` em linha com \`$BASE_BRANCH\`.\n\n- Commits a partir de \`$BASE_BRANCH\`: $COMMITS_FROM_BASE\n- Branch de sincroniza√ß√£o: \`$SYNC_BRANCH\`"

              PR_RESPONSE="$(
                printf '{
                  "title": "%s",
                  "head": "%s",
                  "base": "%s",
                  "body": "%s"
                }' "$PR_TITLE" "$SYNC_BRANCH" "$HEAD_BRANCH" "$PR_BODY" \
                | curl -sS \
                    -H "Authorization: Bearer $GITHUB_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    -X POST "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY/pulls" \
                    -d @-
              )"

              SYNC_PR_NUMBER="$(printf '%s' "$PR_RESPONSE" | python -c 'import sys, json; data=json.load(sys.stdin); print(data.get("number", ""))')"
              SYNC_PR_URL="$(printf '%s' "$PR_RESPONSE" | python -c 'import sys, json; data=json.load(sys.stdin); print(data.get("html_url", ""))')"

              if [ -z "$SYNC_PR_NUMBER" ]; then
                echo "‚ùå Falha ao criar PR de sincroniza√ß√£o."
                echo "$PR_RESPONSE"
                SYNC_MODE="pr_error"
                UPDATED_COMMITS="false"
                SYNC_COMMITS_MESSAGE="‚ùå N√£o foi poss√≠vel criar a PR de sincroniza√ß√£o autom√°tica de \`$BASE_BRANCH\` para \`$HEAD_BRANCH\`. Verifique os logs do workflow."
              else
                MERGE_RESPONSE="$(
                  curl -sS \
                    -X PUT \
                    -H "Authorization: Bearer $GITHUB_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY/pulls/$SYNC_PR_NUMBER/merge" \
                    -d '{"merge_method":"merge"}'
                )"

                MERGED="$(printf '%s' "$MERGE_RESPONSE" | python -c 'import sys, json; data=json.load(sys.stdin); print(data.get("merged", False))')"

                if [ "$MERGED" != "True" ] && [ "$MERGED" != "true" ]; then
                  echo "‚ùå Falha ao mesclar PR de sincroniza√ß√£o: $SYNC_PR_URL"
                  echo "$MERGE_RESPONSE"
                  SYNC_MODE="pr_open"
                  UPDATED_COMMITS="false"
                  SYNC_COMMITS_MESSAGE="‚ö†Ô∏è Foram encontrados $COMMITS_FROM_BASE commit(s) em \`$BASE_BRANCH\` ainda n√£o presentes em \`$HEAD_BRANCH\`, mas n√£o foi poss√≠vel mesclar automaticamente a PR de sincroniza√ß√£o ($SYNC_PR_URL). Verifique a PR e conclua manualmente."
                else
                  echo "‚úÖ PR de sincroniza√ß√£o mesclada com sucesso: $SYNC_PR_URL"

                  curl -sS \
                    -X DELETE \
                    -H "Authorization: Bearer $GITHUB_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY/git/refs/heads/$SYNC_BRANCH" || true

                  SYNC_MODE="pr_merged"
                  UPDATED_COMMITS="true"
                  SYNC_COMMITS_MESSAGE="üîÑ O ramo \`$HEAD_BRANCH\` foi atualizado automaticamente com $COMMITS_FROM_BASE commit(s) de \`$BASE_BRANCH\` via PR de sincroniza√ß√£o ($SYNC_PR_URL)."
                fi
              fi
            else
              git merge --no-ff "origin/$BASE_BRANCH" -m "chore: sync $HEAD_BRANCH with $BASE_BRANCH"
              git push origin "HEAD:$HEAD_BRANCH"

              UPDATED_COMMITS="true"
              SYNC_MODE="direct"
              SYNC_COMMITS_MESSAGE="üîÑ O ramo \`$HEAD_BRANCH\` foi atualizado com $COMMITS_FROM_BASE commit(s) do ramo base \`$BASE_BRANCH\`."
            fi
          fi

          {
            echo "updated_commits=$UPDATED_COMMITS"
            echo "sync_mode=$SYNC_MODE"
            echo "sync_pr_url=$SYNC_PR_URL"
            echo "sync_pr_number=$SYNC_PR_NUMBER"
            echo "sync_branch=$SYNC_BRANCH"
            printf 'message_commits<<EOF\n%s\nEOF\n' "$SYNC_COMMITS_MESSAGE"
          } >> "$GITHUB_OUTPUT"

          exit 0

      - name: Check file diff between head and base branch
        id: diff-status
        env:
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          #!/usr/bin/env bash

          git fetch origin "$BASE_BRANCH" "$HEAD_BRANCH"

          git checkout "$HEAD_BRANCH"
          git reset --hard "origin/$HEAD_BRANCH" || true

          DIFF_FROM_BASE="$(git diff --name-only "HEAD..origin/$BASE_BRANCH" || true)"

          if [ -z "$DIFF_FROM_BASE" ]; then
            echo "‚ÑπÔ∏è Nenhuma altera√ß√£o de arquivos pendente entre $HEAD_BRANCH e origin/$BASE_BRANCH."
            DIFF_HAS_CHANGES="false"
            DIFF_MESSAGE="‚ÑπÔ∏è Nenhuma altera√ß√£o de arquivos pendente entre \`$HEAD_BRANCH\` e \`$BASE_BRANCH\`."
          else
            echo "üîé Foram encontradas altera√ß√µes de arquivos em $BASE_BRANCH que ainda n√£o est√£o em $HEAD_BRANCH:"
            echo "$DIFF_FROM_BASE"
            DIFF_HAS_CHANGES="true"
            DIFF_MESSAGE="üîé Foram encontradas altera√ß√µes de arquivos em \`$BASE_BRANCH\` que ainda n√£o est√£o em \`$HEAD_BRANCH\`.\n\nArquivos afetados:\n\`\`\`\n$DIFF_FROM_BASE\n\`\`\`"
          fi

          {
            echo "diff_has_changes=$DIFF_HAS_CHANGES"
            printf 'message_diff<<EOF\n%s\nEOF\n' "$DIFF_MESSAGE"
          } >> "$GITHUB_OUTPUT"

          exit 0

      - name: Collect repository merge settings and branch protection
        id: repo-settings
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
        run: |
          set -euo pipefail

          GITHUB_API_URL="https://api.github.com"

          REPO_RESPONSE="$(curl -sS \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY")"

          TMP_PROTECTION="$(mktemp)"

          BRANCH_PROT_STATUS="$(curl -sS \
            -o "$TMP_PROTECTION" \
            -w '%{http_code}' \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY/branches/$BASE_BRANCH/protection")"

          PROTECTION_RESPONSE="$(cat "$TMP_PROTECTION" || echo '')"
          rm -f "$TMP_PROTECTION" || true

          export REPO_JSON="$REPO_RESPONSE"
          export PROTECTION_JSON="$PROTECTION_RESPONSE"
          export BRANCH_PROT_STATUS
          export BASE_BRANCH
          export GITHUB_OUTPUT

          python - << 'PY'
          import json
          import os

          def emoji(val):
              if val is True:
                  return "‚úÖ"
              if val is False:
                  return "‚ùå"
              if val is None:
                  return "‚ùî"
              return "‚úÖ" if val else "‚ùå"

          repo_raw = os.environ.get("REPO_JSON", "") or "{}"
          prot_raw = os.environ.get("PROTECTION_JSON", "") or "{}"
          status = os.environ.get("BRANCH_PROT_STATUS", "")
          base_branch = os.environ.get("BASE_BRANCH", "")

          try:
              repo = json.loads(repo_raw)
          except Exception:
              repo = {}

          allow_rebase = repo.get("allow_rebase_merge")
          allow_squash = repo.get("allow_squash_merge")
          allow_merge_commit = repo.get("allow_merge_commit")
          allow_auto_merge = repo.get("allow_auto_merge")
          delete_branch_on_merge = repo.get("delete_branch_on_merge")
          default_branch = repo.get("default_branch")

          linear_history = None
          required_status = None
          strict_status = None
          required_approving = None
          enforce_admins = None
          restrictions = None

          if status == "200":
              try:
                  prot = json.loads(prot_raw)
              except Exception:
                  prot = {}
              else:
                  linear = prot.get("required_linear_history")
                  if isinstance(linear, dict):
                      linear_history = linear.get("enabled")
                  elif isinstance(linear, bool):
                      linear_history = linear

                  rs = prot.get("required_status_checks")
                  if isinstance(rs, dict):
                      checks = rs.get("checks")
                      contexts = rs.get("contexts")
                      required_status = bool(checks or contexts)
                      strict_status = rs.get("strict")

                  rpr = prot.get("required_pull_request_reviews")
                  if isinstance(rpr, dict):
                      required_approving = rpr.get("required_approving_review_count")

                  ea = prot.get("enforce_admins")
                  if isinstance(ea, dict):
                      enforce_admins = ea.get("enabled")
                  elif isinstance(ea, bool):
                      enforce_admins = ea

                  rest = prot.get("restrictions")
                  if isinstance(rest, dict):
                      restrictions = bool(
                          rest.get("users") or rest.get("teams") or rest.get("apps")
                      )

          lines = []
          lines.append("üìã Lista de checagem de merge e prote√ß√£o de branch:")
          lines.append("")
          lines.append("**Configura√ß√£o de merge do reposit√≥rio:**")
          lines.append(f"- Rebase merge habilitado: {emoji(allow_rebase)}")
          lines.append(f"- Squash merge habilitado: {emoji(allow_squash)}")
          lines.append(f"- Merge commit habilitado: {emoji(allow_merge_commit)}")
          lines.append(f"- Auto-merge habilitado: {emoji(allow_auto_merge)}")
          lines.append(f"- Deletar branch no merge: {emoji(delete_branch_on_merge)}")
          if default_branch:
              lines.append(f"- Branch padr√£o do reposit√≥rio: `{default_branch}`")

          if status == "200":
              lines.append("")
              lines.append(f"**Prote√ß√£o do branch base `{base_branch}`:**")
              lines.append(f"- Hist√≥rico linear obrigat√≥rio: {emoji(linear_history)}")
              if required_status is not None:
                  lines.append(f"- Status checks obrigat√≥rios: {emoji(required_status)}")
                  if strict_status is not None:
                      lines.append(f"  - Exigir branch atualizado para merge: {emoji(strict_status)}")
              if required_approving is not None:
                  count = required_approving or 0
                  lines.append(f"- Reviews obrigat√≥rios: {count} aprova√ß√£o(√µes)")
              if enforce_admins is not None:
                  lines.append(f"- Regras v√°lidas tamb√©m para admins: {emoji(enforce_admins)}")
              if restrictions is not None:
                  lines.append(f"- Restri√ß√£o de quem pode pushar: {emoji(restrictions)}")
          else:
              lines.append("")
              lines.append(f"‚ö†Ô∏è N√£o foi poss√≠vel ler a prote√ß√£o do branch `{base_branch}` (status HTTP {status}).")

          msg = "\n".join(lines)

          github_output = os.environ.get("GITHUB_OUTPUT")
          if github_output:
              with open(github_output, "a", encoding="utf-8") as fh:
                  fh.write("message_checklist<<EOF\n")
                  fh.write(msg)
                  fh.write("\nEOF\n")
          else:
              print(msg)
          PY

      - name: Comment sync and changed files status
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          CHANGED_FILES: ${{ github.event.pull_request.changed_files }}
          SYNC_COMMITS_MESSAGE: ${{ steps.sync-commits.outputs.message_commits }}
          DIFF_MESSAGE: ${{ steps.diff-status.outputs.message_diff }}
          CHECKLIST_MESSAGE: ${{ steps.repo-settings.outputs.message_checklist }}
        run: |
          set -euo pipefail

          MSG=""

          if [ -n "${SYNC_COMMITS_MESSAGE:-}" ]; then
            MSG+="$SYNC_COMMITS_MESSAGE\n\n"
          fi

          if [ -n "${DIFF_MESSAGE:-}" ]; then
            MSG+="$DIFF_MESSAGE\n\n"
          fi

          if [ -n "${CHECKLIST_MESSAGE:-}" ]; then
            MSG+="$CHECKLIST_MESSAGE\n\n"
          fi

          if [ "${CHANGED_FILES:-0}" -gt 0 ]; then
            MSG+="‚úÖ Esta Pull Request cont√©m $CHANGED_FILES arquivo(s) alterado(s).\n"
            MSG+="üßæ O fluxo de valida√ß√£o continuar√° normalmente.\n"
          else
            MSG+="‚ÑπÔ∏è Esta Pull Request n√£o possui arquivos alterados (changed_files = ${CHANGED_FILES:-0}).\n"
          fi

          JSON_BODY="$(printf '%b' "$MSG" | jq -Rs '{body: .}')"

          curl -sS \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -X POST "https://api.github.com/repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments" \
            -d "$JSON_BODY" || true

          exit 0
