# .github/workflows/auto-sync.yml
name: "üîÅ auto-sync"

on:
  workflow_call:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-changed-files:
    runs-on: ubuntu-latest
    outputs:
      updated_commits: ${{ steps.sync-commits.outputs.updated_commits }}
      sync_mode: ${{ steps.sync-commits.outputs.sync_mode }}
      sync_pr_url: ${{ steps.sync-commits.outputs.sync_pr_url }}

    steps:
      - name: Checkout PR head branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Sync head branch with base branch (commits)
        id: sync-commits
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          GITHUB_API_URL="https://api.github.com"

          git fetch origin "$BASE_BRANCH" "$HEAD_BRANCH"
          git checkout "$HEAD_BRANCH"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          UPDATED_COMMITS="false"
          SYNC_MODE="none"
          SYNC_PR_URL=""
          SYNC_PR_NUMBER=""
          SYNC_BRANCH=""

          # ------------------------------------------------------------------
          # Descoberta de capacidades do reposit√≥rio e prote√ß√£o do branch
          # ------------------------------------------------------------------
          REPO_RESPONSE="$(
            curl -sS \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY"
          )"

          ALLOW_MERGE_COMMIT="$(
            printf '%s' "$REPO_RESPONSE" | python -c 'import sys,json; data=json.load(sys.stdin); print(str(bool(data.get("allow_merge_commit"))).lower())'
          )"

          ALLOW_SQUASH_MERGE="$(
            printf '%s' "$REPO_RESPONSE" | python -c 'import sys,json; data=json.load(sys.stdin); print(str(bool(data.get("allow_squash_merge"))).lower())'
          )"

          ALLOW_REBASE_MERGE="$(
            printf '%s' "$REPO_RESPONSE" | python -c 'import sys,json; data=json.load(sys.stdin); print(str(bool(data.get("allow_rebase_merge"))).lower())'
          )"

          ALLOW_AUTO_MERGE="$(
            printf '%s' "$REPO_RESPONSE" | python -c 'import sys,json; data=json.load(sys.stdin); print(str(bool(data.get("allow_auto_merge"))).lower())'
          )"

          ALLOW_UPDATE_BRANCH="$(
            printf '%s' "$REPO_RESPONSE" | python -c 'import sys,json; data=json.load(sys.stdin); print(str(bool(data.get("allow_update_branch"))).lower())'
          )"

          MERGE_METHOD="merge"
          if [ "$ALLOW_MERGE_COMMIT" != "true" ]; then
            if [ "$ALLOW_SQUASH_MERGE" = "true" ]; then
              MERGE_METHOD="squash"
            elif [ "$ALLOW_REBASE_MERGE" = "true" ]; then
              MERGE_METHOD="rebase"
            fi
          fi

          BRANCH_PROTECTION_AVAILABLE="false"
          REQUIRED_LINEAR_HISTORY="unknown"
          REQUIRED_STATUS_CHECKS="unknown"
          REQUIRED_STATUS_CHECKS_STRICT="unknown"
          REQUIRED_STATUS_CHECKS_CONTEXTS="(none)"
          REQUIRED_REVIEWS="unknown"
          REQUIRED_APPROVING_REVIEWS="0"
          REQUIRED_CONVERSATION_RESOLUTION="unknown"
          REQUIRED_SIGNATURES="unknown"
          ENFORCE_ADMINS="unknown"

          PROTECTION_RESPONSE="$(
            curl -sS \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY/branches/$HEAD_BRANCH/protection" || true
          )"

          if [ -n "$PROTECTION_RESPONSE" ] && ! printf '%s' "$PROTECTION_RESPONSE" | grep -q '"message"'; then
            BRANCH_PROTECTION_AVAILABLE="true"

            REQUIRED_LINEAR_HISTORY="$(
              printf '%s' "$PROTECTION_RESPONSE" | python -c 'import sys,json; data=json.load(sys.stdin); v=data.get("required_linear_history"); print(str(bool(v and v.get("enabled"))).lower())'
            )"

            REQUIRED_STATUS_CHECKS="$(
              printf '%s' "$PROTECTION_RESPONSE" | python -c 'import sys,json; data=json.load(sys.stdin); print(str(bool(data.get("required_status_checks"))).lower())'
            )"

            REQUIRED_STATUS_CHECKS_STRICT="$(
              printf '%s' "$PROTECTION_RESPONSE" | python -c 'import sys,json; data=json.load(sys.stdin); v=data.get("required_status_checks") or {}; print(str(bool(v.get("strict"))).lower())'
            )"

            REQUIRED_STATUS_CHECKS_CONTEXTS="$(
              printf '%s' "$PROTECTION_RESPONSE" | python -c 'import sys,json; data=json.load(sys.stdin); v=data.get("required_status_checks") or {}; ctx=v.get("contexts") or []; print(",".join(ctx) if ctx else "(none)")'
            )"

            REQUIRED_REVIEWS="$(
              printf '%s' "$PROTECTION_RESPONSE" | python -c 'import sys,json; data=json.load(sys.stdin); print(str(bool(data.get("required_pull_request_reviews"))).lower())'
            )"

            REQUIRED_APPROVING_REVIEWS="$(
              printf '%s' "$PROTECTION_RESPONSE" | python -c 'import sys,json; data=json.load(sys.stdin); v=data.get("required_pull_request_reviews") or {}; print(int(v.get("required_approving_review_count") or 0))'
            )"

            REQUIRED_CONVERSATION_RESOLUTION="$(
              printf '%s' "$PROTECTION_RESPONSE" | python -c 'import sys,json; data=json.load(sys.stdin); v=data.get("required_conversation_resolution"); print(str(bool(v and v.get("enabled", False))).lower())'
            )"

            REQUIRED_SIGNATURES="$(
              printf '%s' "$PROTECTION_RESPONSE" | python -c 'import sys,json; data=json.load(sys.stdin); v=data.get("required_signatures"); print(str(bool(v and v.get("enabled", False))).lower())'
            )"

            ENFORCE_ADMINS="$(
              printf '%s' "$PROTECTION_RESPONSE" | python -c 'import sys,json; data=json.load(sys.stdin); v=data.get("enforce_admins"); print(str(bool(v and v.get("enabled", False))).lower())'
            )"
          fi

          CHECKLIST_MESSAGE="üìã Checklist de configura√ß√£o para merge autom√°tico:\n"
          CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- repo.allow_merge_commit: $ALLOW_MERGE_COMMIT\n"
          CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- repo.allow_squash_merge: $ALLOW_SQUASH_MERGE\n"
          CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- repo.allow_rebase_merge: $ALLOW_REBASE_MERGE\n"
          CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- repo.allow_auto_merge: $ALLOW_AUTO_MERGE\n"
          CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- repo.allow_update_branch: $ALLOW_UPDATE_BRANCH\n"
          CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- auto_sync.merge_method_selecionado: $MERGE_METHOD\n"
          CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- branch.$HEAD_BRANCH.protection.enabled: $BRANCH_PROTECTION_AVAILABLE\n"

          if [ "$BRANCH_PROTECTION_AVAILABLE" = "true" ]; then
            CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- branch.$HEAD_BRANCH.protection.required_linear_history: $REQUIRED_LINEAR_HISTORY\n"
            CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- branch.$HEAD_BRANCH.protection.required_status_checks.enabled: $REQUIRED_STATUS_CHECKS\n"
            CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- branch.$HEAD_BRANCH.protection.required_status_checks.strict: $REQUIRED_STATUS_CHECKS_STRICT\n"
            CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- branch.$HEAD_BRANCH.protection.required_status_checks.contexts: $REQUIRED_STATUS_CHECKS_CONTEXTS\n"
            CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- branch.$HEAD_BRANCH.protection.required_pull_request_reviews.enabled: $REQUIRED_REVIEWS\n"
            CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- branch.$HEAD_BRANCH.protection.required_pull_request_reviews.required_approving_review_count: $REQUIRED_APPROVING_REVIEWS\n"
            CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- branch.$HEAD_BRANCH.protection.required_conversation_resolution.enabled: $REQUIRED_CONVERSATION_RESOLUTION\n"
            CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- branch.$HEAD_BRANCH.protection.required_signatures.enabled: $REQUIRED_SIGNATURES\n"
            CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- branch.$HEAD_BRANCH.protection.enforce_admins.enabled: $ENFORCE_ADMINS\n"
          else
            CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- branch.$HEAD_BRANCH.protection.details: n√£o configurado ou n√£o acess√≠vel pelo GITHUB_TOKEN\n"
          fi

          MERGE_ERROR_MESSAGE=""

          COMMITS_FROM_BASE="$(git rev-list --count "HEAD..origin/$BASE_BRANCH" 2>/dev/null || echo 0)"

          if [ "$COMMITS_FROM_BASE" -eq 0 ]; then
            echo "‚ÑπÔ∏è Nenhum commit pendente em $BASE_BRANCH para sincronizar com $HEAD_BRANCH."
            SYNC_COMMITS_MESSAGE="‚ÑπÔ∏è Nenhum commit pendente no ramo base \`$BASE_BRANCH\` para sincronizar com \`$HEAD_BRANCH\`.\n\n$CHECKLIST_MESSAGE"
          else
            echo "üîÑ Encontrados $COMMITS_FROM_BASE commit(s) em $BASE_BRANCH ainda n√£o presentes em $HEAD_BRANCH."

            if [ "$HEAD_BRANCH" = "main" ] || [ "$HEAD_BRANCH" = "staging" ] || [ "$HEAD_BRANCH" = "development" ]; then
              TS="$(date -u +%Y%m%d-%H%M%S)"
              SYNC_BRANCH="auto-sync/${HEAD_BRANCH}-from-${BASE_BRANCH}-${TS}"

              echo "üîß Branch protegido detectado ($HEAD_BRANCH). Criando branch de sincroniza√ß√£o: $SYNC_BRANCH"

              git checkout -b "$SYNC_BRANCH" "$HEAD_BRANCH"
              git merge --no-ff "origin/$BASE_BRANCH" -m "chore: sync $HEAD_BRANCH with $BASE_BRANCH"

              git push origin "$SYNC_BRANCH"

              PR_TITLE="chore: sync $HEAD_BRANCH with $BASE_BRANCH"
              PR_BODY="PR autom√°tica criada pelo workflow auto-sync para trazer \`$HEAD_BRANCH\` em linha com \`$BASE_BRANCH\`.\n\n- Commits a partir de \`$BASE_BRANCH\`: $COMMITS_FROM_BASE\n- Branch de sincroniza√ß√£o: \`$SYNC_BRANCH\`"

              PR_RESPONSE="$(
                printf '{
                  "title": "%s",
                  "head": "%s",
                  "base": "%s",
                  "body": "%s"
                }' "$PR_TITLE" "$SYNC_BRANCH" "$HEAD_BRANCH" "$PR_BODY" \
                | curl -sS \
                    -H "Authorization: Bearer $GITHUB_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    -X POST "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY/pulls" \
                    -d @-
              )"

              SYNC_PR_NUMBER="$(printf '%s' "$PR_RESPONSE" | python -c 'import sys, json; data=json.load(sys.stdin); print(data.get("number", ""))')"
              SYNC_PR_URL="$(printf '%s' "$PR_RESPONSE" | python -c 'import sys, json; data=json.load(sys.stdin); print(data.get("html_url", ""))')"

              if [ -z "$SYNC_PR_NUMBER" ]; then
                echo "‚ùå Falha ao criar PR de sincroniza√ß√£o."
                echo "$PR_RESPONSE"
                SYNC_MODE="pr_error"
                UPDATED_COMMITS="false"
                SYNC_COMMITS_MESSAGE="‚ùå N√£o foi poss√≠vel criar a PR de sincroniza√ß√£o autom√°tica de \`$BASE_BRANCH\` para \`$HEAD_BRANCH\`. Verifique os logs do workflow.\n\n$CHECKLIST_MESSAGE"
              else
                MERGE_RESPONSE="$(
                  curl -sS \
                    -X PUT \
                    -H "Authorization: Bearer $GITHUB_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY/pulls/$SYNC_PR_NUMBER/merge" \
                    -d "{\"merge_method\":\"$MERGE_METHOD\"}"
                )"

                MERGED="$(printf '%s' "$MERGE_RESPONSE" | python -c 'import sys, json; data=json.load(sys.stdin); print(data.get("merged", False))')"
                MERGE_ERROR_MESSAGE="$(printf '%s' "$MERGE_RESPONSE" | python -c 'import sys, json; data=json.load(sys.stdin); print(data.get("message",""))')"

                SYNC_PR_MERGEABLE_STATE=""
                SYNC_PR_DRAFT=""

                if [ -n "$SYNC_PR_NUMBER" ]; then
                  SYNC_PR_DETAILS="$(
                    curl -sS \
                      -H "Authorization: Bearer $GITHUB_TOKEN" \
                      -H "Accept: application/vnd.github+json" \
                      "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY/pulls/$SYNC_PR_NUMBER"
                  )"

                  SYNC_PR_MERGEABLE_STATE="$(
                    printf '%s' "$SYNC_PR_DETAILS" | python -c 'import sys,json; data=json.load(sys.stdin); print(data.get("mergeable_state",""))'
                  )"

                  SYNC_PR_DRAFT="$(
                    printf '%s' "$SYNC_PR_DETAILS" | python -c 'import sys,json; data=json.load(sys.stdin); print(str(bool(data.get("draft"))).lower())'
                  )"
                fi

                CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE\nüìã Estado da PR de sincroniza√ß√£o:\n"
                CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- sync_pr_number: ${SYNC_PR_NUMBER:-""}\n"
                CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- sync_pr_url: ${SYNC_PR_URL:-""}\n"
                CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- sync_pr_draft: ${SYNC_PR_DRAFT:-""}\n"
                CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- sync_pr_mergeable_state: ${SYNC_PR_MERGEABLE_STATE:-""}\n"
                CHECKLIST_MESSAGE="$CHECKLIST_MESSAGE- sync_pr_merge_error_message: ${MERGE_ERROR_MESSAGE:-""}\n"

                if [ "$MERGED" != "True" ] && [ "$MERGED" != "true" ]; then
                  echo "‚ùå Falha ao mesclar PR de sincroniza√ß√£o: $SYNC_PR_URL"
                  echo "$MERGE_RESPONSE"
                  SYNC_MODE="pr_open"
                  UPDATED_COMMITS="false"
                  SYNC_COMMITS_MESSAGE="‚ö†Ô∏è Foram encontrados $COMMITS_FROM_BASE commit(s) em \`$BASE_BRANCH\` ainda n√£o presentes em \`$HEAD_BRANCH\`, mas n√£o foi poss√≠vel mesclar automaticamente a PR de sincroniza√ß√£o ($SYNC_PR_URL). Verifique a PR e conclua manualmente.\n\n$CHECKLIST_MESSAGE"
                else
                  echo "‚úÖ PR de sincroniza√ß√£o mesclada com sucesso: $SYNC_PR_URL"

                  curl -sS \
                    -X DELETE \
                    -H "Authorization: Bearer $GITHUB_TOKEN" \
                    -H "Accept: application/vnd.github+json" \
                    "$GITHUB_API_URL/repos/$GITHUB_REPOSITORY/git/refs/heads/$SYNC_BRANCH" || true

                  SYNC_MODE="pr_merged"
                  UPDATED_COMMITS="true"
                  SYNC_COMMITS_MESSAGE="üîÑ O ramo \`$HEAD_BRANCH\` foi atualizado automaticamente com $COMMITS_FROM_BASE commit(s) de \`$BASE_BRANCH\` via PR de sincroniza√ß√£o ($SYNC_PR_URL).\n\n$CHECKLIST_MESSAGE"
                fi
              fi
            else
              git merge --no-ff "origin/$BASE_BRANCH" -m "chore: sync $HEAD_BRANCH with $BASE_BRANCH"
              git push origin "HEAD:$HEAD_BRANCH"

              UPDATED_COMMITS="true"
              SYNC_MODE="direct"
              SYNC_COMMITS_MESSAGE="üîÑ O ramo \`$HEAD_BRANCH\` foi atualizado com $COMMITS_FROM_BASE commit(s) do ramo base \`$BASE_BRANCH\`.\n\n$CHECKLIST_MESSAGE"
            fi
          fi

          {
            echo "updated_commits=$UPDATED_COMMITS"
            echo "sync_mode=$SYNC_MODE"
            echo "sync_pr_url=$SYNC_PR_URL"
            echo "sync_pr_number=$SYNC_PR_NUMBER"
            echo "sync_branch=$SYNC_BRANCH"
            printf 'message_commits<<EOF\n%s\nEOF\n' "$SYNC_COMMITS_MESSAGE"
          } >> "$GITHUB_OUTPUT"

          exit 0

      - name: Check file diff between head and base branch
        id: diff-status
        env:
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
          HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          git fetch origin "$BASE_BRANCH" "$HEAD_BRANCH"

          git checkout "$HEAD_BRANCH"
          git reset --hard "origin/$HEAD_BRANCH" || true

          DIFF_FROM_BASE="$(git diff --name-only "HEAD..origin/$BASE_BRANCH" || true)"

          if [ -z "$DIFF_FROM_BASE" ]; then
            echo "‚ÑπÔ∏è Nenhuma altera√ß√£o de arquivos pendente entre $HEAD_BRANCH e origin/$BASE_BRANCH."
            DIFF_HAS_CHANGES="false"
            DIFF_MESSAGE="‚ÑπÔ∏è Nenhuma altera√ß√£o de arquivos pendente entre \`$HEAD_BRANCH\` e \`$BASE_BRANCH\`."
          else
            echo "üîé Foram encontradas altera√ß√µes de arquivos em $BASE_BRANCH que ainda n√£o est√£o em $HEAD_BRANCH:"
            echo "$DIFF_FROM_BASE"
            DIFF_HAS_CHANGES="true"
            DIFF_MESSAGE="üîé Foram encontradas altera√ß√µes de arquivos em \`$BASE_BRANCH\` que ainda n√£o est√£o em \`$HEAD_BRANCH\`.\n\nArquivos afetados:\n\`\`\`\n$DIFF_FROM_BASE\n\`\`\`"
          fi

          {
            echo "diff_has_changes=$DIFF_HAS_CHANGES"
            printf 'message_diff<<EOF\n%s\nEOF\n' "$DIFF_MESSAGE"
          } >> "$GITHUB_OUTPUT"

          exit 0

      - name: Comment sync and changed files status
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          CHANGED_FILES: ${{ github.event.pull_request.changed_files }}
          SYNC_COMMITS_MESSAGE: ${{ steps.sync-commits.outputs.message_commits }}
          DIFF_MESSAGE: ${{ steps.diff-status.outputs.message_diff }}
        run: |
          MSG=""

          if [ -n "${SYNC_COMMITS_MESSAGE:-}" ]; then
            MSG+="$SYNC_COMMITS_MESSAGE\n\n"
          fi

          if [ -n "${DIFF_MESSAGE:-}" ]; then
            MSG+="$DIFF_MESSAGE\n\n"
          fi

          if [ "${CHANGED_FILES:-0}" -gt 0 ]; then
            MSG+="‚úÖ Esta Pull Request cont√©m $CHANGED_FILES arquivo(s) alterado(s).\n"
            MSG+="üßæ O fluxo de valida√ß√£o continuar√° normalmente.\n"
          else
            MSG+="‚ÑπÔ∏è Esta Pull Request n√£o possui arquivos alterados (changed_files = ${CHANGED_FILES:-0}).\n"
          fi

          JSON_BODY="$(printf '%b' "$MSG" | python -c 'import json,sys; print(json.dumps({'"'"'body'"'"': sys.stdin.read()}))')"

          curl -sS \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -X POST "https://api.github.com/repos/$GITHUB
